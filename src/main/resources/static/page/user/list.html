<link href="../../css/bootstrap.min.css" rel="stylesheet">
<link href="../../css/materialdesignicons.min.css" rel="stylesheet">
<!--标签插件-->
<link rel="stylesheet" href="../../js/jquery-tags-input/jquery.tagsinput.min.css">
<link href="../../css/style.min.css" rel="stylesheet">
<!--对话框-->
<link rel="stylesheet" href="../../js/jconfirm/jquery-confirm.min.css">

<!-- 编辑模态框 -->
<div class="modal fade bs-example-modal-lg" id="edit-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">编辑用户</h4>
            </div>
            <div class="modal-body">
                <div class="form-group col-md-12">
                    <label>用户名</label>
                    <input type="text" class="form-control" id="edit_username" placeholder="请输入用户名" />
                </div>
                <div class="form-group col-md-12">
                    <label>密码</label>
                    <input type="password" class="form-control" id="edit_password" placeholder="请输入密码" />
                </div>
                <div class="form-group col-md-12">
                    <label>真实姓名</label>
                    <input type="text" class="form-control" id="edit_realname" placeholder="请输入真实姓名" />
                </div>
                <div class="form-group col-md-12">
                    <label>性别</label>
                    <div class="clearfix">
                        <label class="lyear-radio radio-inline radio-primary">
                            <input type="radio" name="edit_sex" value="男" id="edit_male"><span>男</span>
                        </label>
                        <label class="lyear-radio radio-inline radio-primary">
                            <input type="radio" name="edit_sex" value="女" id="edit_female" checked><span>女</span>
                        </label>
                    </div>
                </div>
                <div class="form-group col-md-12">
                    <label>邮箱</label>
                    <input type="text" class="form-control" id="edit_email" placeholder="请输入邮箱" />
                </div>
                <div class="form-group col-md-12">
                    <label>手机号码</label>
                    <input type="text" class="form-control" id="edit_mobile" placeholder="请输入手机号码" />
                </div>
                <div class="form-group col-md-12">
                    <label>身份证号码</label>
                    <input type="text" class="form-control" id="edit_id_code" placeholder="请输入身份证号码" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="save_btn">点击保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看详细信息模态框 -->
<div class="modal fade bs-example-modal-lg" id="view-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">详细信息</h4>
            </div>
            <div class="modal-body">
                <div class="form-group col-md-12">
                    <label>用户名</label>
                    <input type="text" class="form-control" id="view_username" readonly />
                </div>
                <div class="form-group col-md-12">
                    <label>密码</label>
                    <input type="text" class="form-control" id="view_password" readonly />
                </div>
                <div class="form-group col-md-12">
                    <label>真实姓名</label>
                    <input type="text" class="form-control" id="view_realname" readonly />
                </div>
                <div class="form-group col-md-12">
                    <label>性别</label>
                    <input type="text" class="form-control" id="view_sex"  readonly />
                </div>
                <div class="form-group col-md-12">
                    <label>邮箱</label>
                    <input type="text" class="form-control" id="view_email" readonly />
                </div>
                <div class="form-group col-md-12">
                    <label>手机号码</label>
                    <input type="text" class="form-control" id="view_mobile" readonly />
                </div>
                <div class="form-group col-md-12">
                    <label>身份证号码</label>
                    <input type="text" class="form-control" id="view_id_code" readonly />
                </div>
                <div class="form-group col-md-12">
                    <label>创建日期</label>
                    <input type="text" class="form-control" id="view_gmt_create" readonly />
                </div>
                <div class="form-group col-md-12">
                    <label>修改日期</label>
                    <input type="text" class="form-control" id="view_gmt_modified" readonly />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-toolbar clearfix">
                    <div class="form-inline col-lg-6" >
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-addon">用户名</div>
                                <input type="text" class="form-control" id="username" placeholder="支持模糊查询">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-addon">性别</div>
                                <select class="form-control" id="sex-select">
                                    <option value="-1" selected>全部</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-addon">状态</div>
                                <select class="form-control" id="is-delete-select">
                                    <option value="-1" selected>全部</option>
                                    <option value="0">未删除</option>
                                    <option value="1">已删除</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" id="search-btn" class="btn btn-primary">查询</button>
                    </div>
                    <div class="toolbar-btn-action col-lg-4 col-lg-offset-2">
                        <a class="btn btn-primary m-r-5" href="#!"><i class="mdi mdi-plus"></i> 新增</a>
                        <a class="btn btn-success m-r-5" href="#!"><i class="mdi mdi-check"></i> 启用</a>
                        <a class="btn btn-warning m-r-5" href="#!"><i class="mdi mdi-block-helper"></i> 禁用</a>
                        <a class="btn btn-danger" href="#!"><i class="mdi mdi-window-close"></i> 删除</a>
                    </div>
                </div>

                <div class="card-body">

                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>用户名</th>
                                <th>真实姓名</th>
                                <th>性别</th>
                                <th>邮箱</th>
                                <th>手机号码</th>
                                <th>身份证号码</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="tbody">
                                <!-- 留下一个空的tbody，用来放ajax从后端请求得到的表格数据,起一个id(为了在js代码中找到这个tbody)-->
                            </tbody>
                        </table>
                    </div>
                    <ul class="pagination">
                        <li><button id="pre-btn" class="btn btn-primary">上一页</button></li>
                        <li><button id="next-btn" class="btn btn-primary">下一页</button></li>
                        <li>
                            一共有<i id="totalCount"></i>条数据
                            当前是第<i id="current"></i>/<i id="totalPage"></i>页
                        </li>
                    </ul>

                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="../../js/jquery.min.js"></script>
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
<script src="../../js/bootstrap-notify.min.js"></script>
<script type="text/javascript" src="../../js/lightyear.js"></script>
<!--对话框-->
<script src="../../js/jconfirm/jquery-confirm.min.js"></script>
<script>
    /* 声明分页, 条件查询基础变量 */
    let current,pageSize,totalPage,totalCount,username,sex,isDelete ;
    /* 声明分页,条件查询元素对象 */
    let $tbody,$preBtn,$nextBtn,$searchBtn;
    /* 声明修改数据的元素对象*/
    let $editUsername,$editPassword,$editRealname,$editEmail,$editMobile,$editIdCode,$editMale,$editFemale,$saveBtn;
    /* 声明查看详细信息的元素对象*/
    let $viewUsername,$viewPassword,$viewRealname,$viewEmail,$viewMobile,$viewIdCode,$viewSex,$viewGmtCreate,$viewGmtModified;
    /* 声明点击编辑按钮调用的函数, 参数是id */
    function edit(id) {
        $.getJSON("/api/user/view/" + id,function (data) {
            if(data.code == "00000"){
                let user = data.data;
                $editUsername.val(user.username);
                $editPassword.val(user.password);
                $editRealname.val(user.realname);
                $editEmail.val(user.email);
                $editMobile.val(user.mobile);
                $editIdCode.val(user.idCode);
                if(user.sex == "男"){
                    $editMale.prop("checked",true)
                }else if(user.sex == "女"){
                    $editFemale.prop("checked",true)
                }
                $saveBtn.click(function () {
                    $.confirm({
                        title: '警告',
                        content: '确定修改吗?',
                        type: 'orange',
                        typeAnimated: false,
                        buttons: {
                            omg: {
                                text: '确定',
                                btnClass: 'btn-orange',
                                action:function () {
                                    let data = {
                                        id:id,
                                        username:$editUsername.val(),
                                        password:$editPassword.val(),
                                        realname: $editRealname.val(),
                                        email:$editEmail.val(),
                                        mobile:$editMobile.val(),
                                        idCode:$editIdCode.val()
                                    }
                                    $.post("/api/user/update",data,function (data) {
                                        if(data.code == "00000"){
                                            lightyear.notify("修改成功!", 'success', 3000);
                                            $("#edit-modal").modal('hide');
                                            loadPageData()
                                        }else {
                                            lightyear.notify(data.msg, 'danger', 3000);
                                        }
                                    })
                                }
                            },
                            close: {
                                text: '关闭',
                            }
                        }
                    });
                })
            }else {
                lightyear.notify(data.msg, 'danger', 2000);
            }
        })
    }
    /* 声明点击删除按钮调用的函数, 参数是id */
    function del(id) {
        $.confirm({
            title: '警告',
            content: '确定删除吗?',
            type: 'orange',
            typeAnimated: false,
            buttons: {
                omg: {
                    text: '确定',
                    btnClass: 'btn-orange',
                    action:function () {
                        let data = {
                            id:id,
                            isDelete:1
                        }
                        $.post("/api/user/update",data,function (data) {
                            if(data.code == "00000"){
                                lightyear.notify("删除成功!", 'success', 3000);
                                loadPageData();
                            }else {
                                lightyear.notify(data.msg, 'danger', 3000);
                            }
                        })
                    }
                },
                close: {
                    text: '关闭',
                }
            }
        });
    }
    /* 声明点击查看按钮调用的函数, 参数是id */
    function view(id) {
        $.getJSON("/api/user/view/" + id,function (data) {
            if(data.code == "00000"){
                let user = data.data;
                $viewUsername.val(user.username);
                $viewPassword.val(user.password);
                $viewRealname.val(user.realname);
                $viewEmail.val(user.email);
                $viewMobile.val(user.mobile);
                $viewIdCode.val(user.idCode);
                $viewSex.val(user.sex);
                $viewGmtCreate.val(user.gmtCreate);
                $viewGmtModified.val(user.gmtModified);
            }else {
                lightyear.notify(data.msg, 'danger', 3000);
            }

        })
    }
    /* 加载分页多条件查询数据的函数 */
    function loadPageData() {
        let data = {
            current,  // current:current
            pageSize,
            username:username?username:null,
            sex:sex==-1?null:sex,
            isDelete:isDelete==-1?null:isDelete
        }
        $.getJSON('/api/user/list',data,function (data) {
            /* 回调函数中的data = 服务器返回的响应报文responseData*/
            /* data.data = 响应报文中的page分页器对象 */
            if(data.code == "00000"){
                let page = data.data; // 取出分页器对象
                totalPage = page.pages;//  从分页器对象中取出总页数
                totalCount = page.total; // 从分页器对象中取出一共有多少条数据
                let list = page.records; // 从分页器对象中取出当前这一页的数据集合
                let tbodyHtml = "";
                for(let i = 0;i<list.length;i++){// 迭代list数据集合
                    let item = list[i]; // 从集合中取出一个对象
                    /* 使用反引号加模板字符串${}取值进行拼接, 将一个对象拼接为一个tr标签 */
                    let tr = `<tr>
                                    <td>${item.username}</td>
                                    <td>${item.realname}</td>
                                    <td>${item.sex}</td>
                                    <td>${item.email}</td>
                                    <td>${item.mobile}</td>
                                    <td>${item.idCode}</td>
                                    <td>
                                        <a class="btn btn-xs btn-default" href="javascript:void(0)" onclick="edit(${item.id})" title="编辑" data-toggle="modal" data-target="#edit-modal"><i class="mdi mdi-pencil"></i></a>
                                        <a class="btn btn-xs btn-default" href="javascript:void(0)" onclick="view(${item.id})" title="查看" data-toggle="modal" data-target="#view-modal"><i class="mdi mdi-eye"></i></a>
                                        <a class="btn btn-xs btn-default" href="javascript:void(0)" onclick="del(${item.id})" title="删除" data-toggle="tooltip"><i class="mdi mdi-window-close"></i></a>
                                    </td>
                                  </tr>`;
                    tbodyHtml += tr;
                }
                /* 经过for循环后将集合拼接为多个tr，然后将他们放入到tbody里面去 */
                $tbody.html(tbodyHtml);
                /* 填入分页信息*/
                $("#totalCount").text(totalCount);
                $("#current").text(current);
                $("#totalPage").text(totalPage);
            }else {
                lightyear.notify(data.msg, 'danger', 3000);
            }
        })
    }
    /* jQuery初始化函数 */
    $(function () {
        /* 初始化分页, 条件查询基础变量 */
        current = 1; // 默认当前是第一页
        pageSize = 10; // 每页默认显示10条数据
        totalPage = 0; // 一共有多少页 (需要从服务器查出来)
        totalCount = 0; // 一共有多少条数据 (需要从服务器查出来)
        username = ''; // 用户名查询条件值变量
        sex = -1; // 性别查询条件值变量
        isDelete = -1; // 是否已删除查询条件值变量

        /* 初始化分页,条件查询元素对象*/
        $tbody = $("#tbody");// 获取存放数据的表格的tbody对象
        $preBtn = $("#pre-btn");// 获取上一页按钮对象
        $nextBtn = $("#next-btn");// 获取下一页按钮对象
        $searchBtn = $("#search-btn");// 获取查询按钮对象

        /* 初始化修改数据的元素对象 */
        $editUsername = $("#edit_username");
        $editPassword = $("#edit_password");
        $editRealname = $("#edit_realname");
        $editEmail = $("#edit_email");
        $editMobile = $("#edit_mobile");
        $editIdCode = $("#edit_id_code");
        $editMale = $("#edit_male");
        $editFemale= $("#edit_female");
        $saveBtn = $("#save_btn");

        /* 初始化查看详细信息的元素对象 */
        $viewUsername = $("#view_username");
        $viewPassword = $("#view_password");
        $viewRealname = $("#view_realname");
        $viewEmail = $("#view_email");
        $viewMobile = $("#view_mobile");
        $viewIdCode = $("#view_id_code");
        $viewSex = $("#view_sex");
        $viewGmtCreate = $("#view_gmt_create");
        $viewGmtModified = $("#view_gmt_modified");

        /* 点击上一页按钮, 页码-1, 然后调用loadPageData函数 */
        $preBtn.click(function () {
            if(current == 1){ // 如果页码变量已经是1了, 就不能再-1了, 因为没有第0页
                lightyear.notify('已经是第一页了', 'danger', 3000);
                return; // 直接return掉
            }else {
                current --; // 当前页码 -1
            }
            loadPageData(); // 调用查询数据的方法
        })
        /* 点击下一页按钮, 页码+1, 然后调用loadPageData函数 */
        $nextBtn.click(function () {
            if(current == totalPage){ // 如果页码变量已经等于总页数了, 说明现在已经是最后一页了,就不能再+1了
                lightyear.notify('已经是最后一页了', 'danger', 3000);
                return;
            }else {
                current ++; // 当前页码+1
            }
            loadPageData(); // 调用查询数据的方法
        });
        /*查询按钮点击事件*/
        $searchBtn.click(function () {
            username = $("#username").val();
            sex = $("#sex-select").val();
            isDelete = $("#is-delete-select").val();
            loadPageData(); // 调用查询数据的方法
        })

        /* 页面加载成功后立即调用loadPageData函数 */
        loadPageData();
    })
    /* End jQuery初始化函数*/

</script>